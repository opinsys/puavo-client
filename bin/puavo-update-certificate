#!/usr/bin/ruby1.9.1

require "openssl"
require "puavo/rest-client"

certificate_private_key = "/etc/puavo/certs/host.key"
certificate_file = "/etc/puavo/certs/host.crt"
orgcabundle_file = "/etc/puavo/certs/orgcabundle.pem"
hostorgcabundle_file = "/etc/puavo/certs/hostorgcabundle.pem"

cert = OpenSSL::X509::Certificate.new( File.read(certificate_file) )

if (cert.not_after - 60 * 60 * 24 * 180) > Time.now
  # Certificate is valid, not need to update
  exit
end

# Read old private key and create certificate request
key_pem = File.read certificate_private_key
key = OpenSSL::PKey::RSA.new key_pem
csr = OpenSSL::X509::Request.new
csr.version = 0
csr.public_key = key.public_key

client = PuavoRestClient.new( :auth => :etc,
                              :dns => :no )

response = client.post("/v3/hosts/certs/sign",
                       :json => {
                         "certificate_request" => csr.to_pem,
                         "hostname" => Socket.gethostname
                       })

if response.code.to_i != 200
  puts "Unable to sign certificate"
  begin
    puts "ERROR: " + JSON.parse(response.body)["error"]
  rescue Exception => e
    puts "Unable to parse response! (#{ e })"
  end
  exit 1
end

host = JSON.parse(response.body)

if host["certificate"]
  puts "Update host certificate:"

  orgcabundle = File.open(orgcabundle_file).read

  File.open(certificate_file + ".tmp", 'w', 0400) { |f| f.print host["certificate"] }
  File.open(hostorgcabundle_file + ".tmp", 'w', 0400) { |f| f.print host["certificate"] + orgcabundle }

  puts "\t* " + certificate_file
  File.rename(certificate_file + ".tmp", certificate_file)
  puts "\t* " + hostorgcabundle_file
  File.rename(hostorgcabundle_file + ".tmp", hostorgcabundle_file)

  if File.directory?("/state/etc/puavo/certs")
    File.open("/state" + certificate_file + ".tmp", 'w', 0400) { |f| f.print host["certificate"] }
    File.open("/state" + hostorgcabundle_file + ".tmp", 'w', 0400) { |f| f.print host["certificate"] + orgcabundle }

    puts "\t* " + "/state" + certificate_file
    File.rename("/state" + certificate_file + ".tmp", "/state" + certificate_file)
    puts "\t* " + "/state" + hostorgcabundle_file
    File.rename("/state" + hostorgcabundle_file + ".tmp", "/state" + hostorgcabundle_file)
  end
end
